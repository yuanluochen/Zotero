研究与开发
现代计算机(www.moderncomputer.cn) 2020.12 下
文章编号:1007-1423(2020)36-0009-06 DOI:10.3969/j.issn.1007-1423.2020.36.002
基于运动学建模的自动瞄准系统
宋珣,马智博
(西安交通大学自动化系,西安 710049)
摘要:
RoboMaster 全国机器人大赛是机器人竞技类比赛,在比赛中双方机器人需要用弹丸精准打击对方机器人的特定部 位。近年来诸多参赛队伍意识到给机器人装配自动瞄准系统的重要性,同时每个队伍也都做了一定的反自动瞄准措 施。多数队伍采用的传统自瞄系统在面对反自瞄措施时都会失灵,因此针对反自瞄措施的技术原理,提出基于运动 学建模的自动瞄准系统,能够有效地弥补传统自瞄系统的缺陷。 关键词:
自动瞄准;反自瞄;运动学
0 引言
在 RoboMaster 机器人比赛中,机器人的前后左右 方向各有一块装甲板。机器人需要用弹丸精准打击敌 方机器人的装甲板。打击的精确度是决定比赛的胜负 走向的关键因素,所以近年来几乎所有队伍都开始给 机器人配备自动瞄准系统,用以提升命中率。 大多数队伍的自动瞄准系统其原理和流程是相似 的,大体都可以分为目标检测和运动预测两步。反自 瞄系统基本是针对后者研制的,即利用自瞄系统中运 动预测功能的缺陷,使得敌方机器人的自瞄系统在特 定情况下失灵。本文将介绍一种在传统运动预测功能 上有较大改进的自动瞄准系统,其综合效果良好,我们 的参赛队伍在 2019 年 RoboMaster 全国机器人竞赛中 获得一等奖。
1 基础模型
1.1 目标检测
目标检测是通过对摄像头捕获的图像进行处理, 从而得到视野中敌方机器人暴露出的装甲板的空间位 置。这是自动瞄准的首要步骤。比赛中的步兵机器人 和其装甲板如图 1 所示。可以看到装甲板有一些明显 的视觉特征,于是先通过颜色和亮度筛序出光条(图中
数字 5 两侧的亮蓝色部分即为光条),再通过他们之间 的几何关系匹配出可能是装甲板的组合,最后将可能 的组合通过神经网络对其中间部分的区域进行判断, 判断其是装甲板还是干扰组合,如果是装甲板则给出 其数字,如图 1 中,装甲板数字为 5。
图 1 步兵机器人
判断出灯条组合确实为装甲板后,因为装甲板的 真实尺寸是已知的,摄像头的内参矩阵也是已知的,所 以能够结合装甲板在图像中的位置计算出其相对于相 机的空间坐标。 1.2 坐标系建立
通过目标检测,得到了视野中的装甲板在相机坐 标系中的位置,然而机器人的相机是跟随云台一起转
❾


研究与开发
现代计算机(www.moderncomputer.cn) 2020.12 下
动的,所以相机坐标系本身的方向是不断变化的。我 们希望能够在一个方向不变的坐标系中研究目标的运 动,所以就利用陀螺仪计算出一个方向不变的“绝对” 坐标系,该坐标系的原点在己方机器人中心,方向始终 固定在陀螺仪上电时云台的方向。 综上所述,在自动瞄准系统中,一共维护三个坐标 系:目标机器人坐标系 {XR,YR,ZR} ,中心固连于己方机 器人中心而方向不变的绝对坐标系 {XI,YI,ZI} 和相机 坐标系 {XC,YC,ZC} 。其中 { }
XI,YI,ZI 和 {XC,YC,ZC} 的 Z
轴是同轴的,它们之间的关系如图 2 所示。因此,它们 之间可以通过旋转一个角度 θ 来转换,θ 可由陀螺仪 测得的角速度做积分直接得到。设目标装甲板在相机 坐标系中的位置为 PC =(xC,yC,zC) ,则它在绝对坐标系 中的位置 PI =(xI,yI,zI) 可以由式(1)得到: P
I = R(θ)PC (1)
其中:
R(θ) = é ë
êê
ù
û
úú
cos θ sin θ 0
-sin θ cos θ 0
0 0 1 (2)
图 2 坐标系转换关系
运动预测需要的是装甲板的绝对坐标 PI ,所以通 过 1 式进行转换是目标检测的最后一步。需要的注意 的是,这里的“绝对”不等同于真正意义上的惯性系。 “绝对”只是代表其 XI 轴和 YI 轴的指向是不变的,但其 坐标轴原点却是随己方机器人中心一起运动的。 1.3 运动预测
当得到了目标在绝对坐标系的位置后,最符合直 觉的做法是:将云台转动至目标方向,然后射击弹丸。 但摄像头的读图延迟 tr 、工控机的图像处理延迟 tp 和 上位机到下位机的信息传输延迟 tt 会导致我们得到的 目标位置总是滞后于目标每个时刻的真实位置。再加 上子弹的飞行延迟 t f ,其结果是:当目标在运动时,子 弹 总 会 落 在 目 标 在 前 几 个 时 刻 的 位 置 ,命 中 率 非 常 低。所以我们最好能够得到目标的运动规律,将各种
延迟考虑之后计算出在保持原有运动规律的情况下几 个时刻之后目标所处的位置,然后以该位置作为击打 对象。 要得到目标的运动规律,就要用多个时刻的目标 位置 Pi(i = 1,2...n) 进行计算。例如,对于同一块装甲 板,我们得到它在 k 个连续时刻的绝对位置 P1 , P2 ... Pk 。假设目标进行的是匀速直线运动且 k 取 8,则可 以利用式 3 计算出目标速度,其中 tmn 代表 m 时刻到 n 时刻经历的时间之和。
V
1~8 =
P
8 - P4
t
48
+ P7 - P3
t
37
+ P6 - P2
t
26
+ P5 - P1
t
15
4
(3)
以上几种延迟之和 ∆t 可由式 4 得到:
∆t = tr + tp + tt + t f (4)
则预测出的实际应该击打的位置 Ppre 是: P
pre = Pk + ∆t × V1~k (5) 这种传统的运动预测方式的核心是假设目标做匀 速直线运动,由于工控机有着较高的图像处理速度,处 理效率可达 70-80Hz,所以在几个时刻的时间段内实 际只经过了不到 100 毫秒,在如此短的时间内假设目 标做匀速直线运动确实是可行的,但面对后面提到的 反自瞄措施时,此种建模方式会呈现出很大的弊端。
2 模型改进
2.1 反自瞄措施
大多数队伍采用的自动瞄准方式都如同上一章所 述,且其中有相当部分的队伍连基础的运动预测都没 有做。所以针对自动瞄准系统的固有弊端,即不可消 除的延迟,几乎所有战队都给机器人设置了自旋模式, 这就是反自瞄措施。 在开启自旋模式之后,机器人以每秒 2 到 4 圈的 速度自转,且由于采用了麦克纳姆轮,在自旋的同时还 可以进行水平移动。这样做可以使得机器人四周的四 块装甲板轮流出现在敌人的视野中,且每块装甲板出 现的时间很短,通常只有不到 150 毫秒。在自旋时装 甲板的水平坐标 XI 实际上是一个正弦函数,在这种情 况下,如果使用上一章的运动预测模型,则预测的打击 位置大概率会落在敌方机器人外部,预测位置与真实 位置的误差关系如图 3 所示。
􀀡􀀪


研究与开发
现代计算机(www.moderncomputer.cn) 2020.12 下
图 3 预测位置误差
在图 3 中,我们选取 t1 作为计算目标速度的起始 时刻,t2 作为终止时刻,它们分别对应上一章的 t1 和 t
k ,以此结合式(3)计算出目标的运动速度,如图中的直 线所示,直线斜率即为在 XI 轴方向的运动速度。在 t2 位置的基础上,用预测的速度延后一个时间 ∆t ,得到 预测位置 Xpre ,然而实际的位置是 Xtrue 。它们之间的误 差为 Error = Xpre - Xtrue 。在如此大的误差下基本是不可 能打中的。 通过机器人的简化自旋示意图可以直观理解打不 中的原因。如图 4 所示,图中 ω 代表旋转角速度,由中 心处引出的两个箭头分别代表机器人在 t1 和 t2 两个时 刻的正前方,本例中我们跟踪的是机器人右侧的装甲 板。选取好 t1 和 t2 之后可以利用(3)式计算出装甲板 速度 Vpre 。
图 4 简化自旋示意图
在 t2 位置基础上,以速度 Vpre 延迟 ∆t 的时间得到 预测位置 Ppre ,然而经过时间 ∆t 之后跟踪的装甲板已
经转到了我们看不到的侧面,所以这时已经不可能打 中了,如图 5 所示。
图 5 预测位置示意图
2.2 运动学建模
由上一节分析可知,在敌方机器人开启自旋之后, 如果我们想打中正在观察的装甲板,是很难的。这主 要是由于当我们做出预测反应之后,被观察的装甲板 已经消失在视野中了,所以这时无论用何种方式优化 单一装甲板运动规律的求解方式都是徒劳的。 所以我们应当将注意力放在其他的装甲板上面, 也就是说,虽然前几个时刻被观察的装甲板已经转到 了我们无法射击到的视野盲区,但机器人的四周都有 装甲板,所以会有下一块装甲板出现在视野中。如果 我们知道了敌方机器人的几何参数和整体运动规律, 则可以通过当前正在观察的装甲板来预测下一块装甲 板的运动规律,转而将攻击对象变为下一块装甲板,这 样就有充足的时间准备射击。从而可以有效提升命 中率。 在确定模型参数之前,为便于分析,需要先确定一 些假设条件。首先是假设目标机器人在自旋时会进行 水平移动,且它相对于己方机器人的移动是匀速直线 运动。其次假设目标机器人的自转速度是恒定的。最 后假设目标机器人的 4 块装甲板的中心经过机器人的 两条对称轴。通过我们进行的实验和对大多数队伍机 器人的观察可以得出,这 3 条假设是合理的。 对于目标机器人,几乎所有参数都是未知的,所以 需要列出所有我们感兴趣的参数,然后用观察到的信
􀀡 􀀫


研究与开发
现代计算机(www.moderncomputer.cn) 2020.12 下
息进行建模和求解。需要的参数如表 1 所示。
表 1 符号含义
运动学建模后机器人的表示如图 6 所示。
图 6 运动学建模
若在某一起始时刻 t1 观察到目标装甲板位置为 (XO1,YO1) ,则可以写出式(6)的一组约束条件。
ìíî
X
C + L1* sin(θR) = XO1 Y
C - L1* cos(θR) = YO1
(6)
从起始时刻经过一个时间 ∆t 之后,到达时刻 i 。 则会得到式(7)的一组约束条件。
ì í î
ï
ï
XC + V·∆t· cos(θV) + L1· sin( )
θR + ω·∆t = XOi XC + V·∆t· sin(θV) - L1· cos( )
θR + ω·∆t = YOi
(7)
当然,式(6)可以看成式(7)的特殊情况,即 ∆t = 0 的情况。可以看到方程组的未知参数有: XC,YC,L1,θR,θV,V, ω 。每一次观察会产生一组(2 个)方 程,其中 XOi,YOi,∆t 是已知的。所以理论上可以通过至 少 3 次观察得到的 6 个方程解出 6 个未知参数。
不过在(7)式中,有非线性部分 sin( )
θR + ω·∆t 和
cos( )
θR + ω·∆t ,如果存在这样的非线性部分,会给求解
带来很大麻烦。所以,使用一阶泰勒展开将其化为线 性形式。一阶泰勒展开公式如式(8)所示。可以使用
泰勒展开进行化简是因为我们是在一个很小的时间间 隔内求解运动学参数,所以 ∆t 也是较小的值。 f (x) = f (x0) + f'(x0)( )
x - x0 + o( )
x - x0 (8)
忽 略 无 穷 小 项 o( )
x - x0 ,得 sin( )
θR + ω·∆t 和
cos( )
θR + ω·∆t 在 θR 处的一阶泰勒展开为式(9)。
ìíî
sin(θR) + cos(θR)·ω·∆t
cos(θR) - sin (θR)·ω·∆t (9)
所以式(7)被线性化后的表示如式(10)所示。
ìíî
XC + V·∆t· cos(θV) + L1·[sin(θR) + cos(θR)·ω·∆t] = XOi YC + V·∆t· sin(θV ) - L1·[cos(θR) - sin(θR)·ω·∆t] = YOi
(10) 将式(10)写成矩阵形式是:
[]
1 ∆t 1 ∆t
é
ë
ê
ê
êêê
ê
ù
û
ú
ú
úúú
ú
X
C
V· cos(θV) L
1· sin(θR) L
1· cos(θR)·ω
= XOi
[]
1 ∆t 1 ∆t
é
ë
ê
ê
êêê
ê
ù
û
ú
ú
úúú
ú
Y
C
V· sin(θV) -L1· cos(θR) L
1· sin(θR)·ω
= YOi
当有 k 组观测时,矩阵形式的表达如式(11)所示。
ì
í
î
ï
ï
ï
ïïï
ï
ï
ï
ï
ï
ïïï
ï
ï
é
ë
ê
ê
êêê
ê
ù
û
ú
ú
úúú
ú
1 ∆t1 1 ∆t1 1 ∆t2 1 ∆t2 ⋮
1 ∆tk 1 ∆tk
é
ë
ê
ê
êêê
ê
ù
û
ú
ú
úúú
ú
X
C
V· cos(θV) L
1· sin(θR) L
1· cos(θR)·ω
=
é
ë
ê
ê
êê ê
êù
û
ú
ú
úú ú
ú
X
XOO12 ⋮ X
Ok
é
ë
ê
ê
êêê
ê
ù
û
ú
ú
úúú
ú
1 ∆t1 1 ∆t1 1 ∆t2 1 ∆t2 ⋮
1 ∆tk 1 ∆tk
é
ë
ê
ê
êêê
ê
ù
û
ú
ú
úúú
ú
Y
C
V· sin(θV) -L1· cos(θR) L
1· sin(θR)·ω
=
é
ë
ê
ê
êê ê
êù
û
ú
ú
úú ú
ú
Y
YOO12 ⋮
YOk
(11)
为方便起见将矩阵
é
ë
ê
ê
êêê
ê
ù
û
ú
ú
úúú
ú
1 ∆t1 1 ∆t1 1 ∆t2 1 ∆t2 ⋮
1 ∆tk 1 ∆tk
记 为 K,将
é
ë
ê
ê
êêê
ê
ù
û
ú
ú
úúú
ú
XC
V· cos(θV) L
1· sin(θR) L
1· cos(θR)·ω
和
é
ë
ê
ê
êêê
ê
ù
û
ú
ú
úúú
ú
YC
V· sin(θV) -L1· cos(θR) L
1· sin(θR)·ω
分 别 记 为 T1 和 T2 ,将
é
ë
ê
ê
êê ê
êù
û
ú
ú
úú ú
ú
XXOO12
⋮
XOk
和
é
ë
ê
ê
êê ê
êù
û
ú
ú
úú ú
ú
YYOO12
⋮
YOk
分别记为 U1 和 U2 。则可将式(11)简写为
式(12)。
􀀡􀀬


研究与开发
现代计算机(www.moderncomputer.cn) 2020.12 下
{
KT1 = U1
KT2 = U2
(12)
若 k=4,则 可 以 直 接 通 过 T1 = K-1U1 和 T2 = K-1U2 求解。 若 k ≥ 4 ,则式(12)是一个超定方程。可以用伪逆 求解。即:
ìíî
T
1 = (KT K)-1KTU1 T
2 = (KT K)-1KTU2
(13)
当 解 出 T1 和 T2 之 后 ,就 可 以 很 容 易 的 解 出 XC,YC,L1,θR,θV,V, ω 这 6 个未知数。同样,当下一块装 甲板出现在视野中后,就可以计算出 L2 的值。如此,我 们得到了目标机器人必要的几何参数和它的运动学参 数。这样,通过当前正在观察的装甲板的位置,可以推 知该机器人剩余三块装甲板的位置和它们在将来一小 段时间内的运动轨迹。于是,可以预测还未出现在视 野中的装甲板在将来几个时刻的位置并对其进行击 打。而不是像上一章的运动预测系统——预测和射击 仅局限于被观察的一块装甲板。在目标机器人自旋 时,一块装甲板被观察并计算出运动规律之后,很快就 会消失在视野中,所以传统运动预测系统面对自旋时 效果极差。而引入运动学建模的运动预测系统将装甲 板的观测与射击分离,就较好地解决了该问题。 2.3 卡尔曼滤波
上述运动预测过程是在下位机完成的,下位机使 用 k 组观测进行计算就需要从上位机接收 k 次数据。 受摄像头帧率的限制,上位机产生两组有效数据的时 间间隔大约是 14 毫秒,如果中间目标检测环节受到干 扰 ,数 据 间 断 的 时 间 还 会 更 久 ,即 数 据 更 新 频 率 在 70Hz 以下。然而如果下位机对云台的控制频率也保 持在 70Hz 上下,会产生较大的延迟和抖动。所以下位
机需要在两组有效数据的时间间隔内通过已有数据自 行生成控制指令,这就需要通过目标机器人几何参数 和运动规律生成状态转移方程,假设通过最后一次有 效数据计算出的参数为 XC,YC,L1,θR,θV,V, ω ,则在基础 上经过 ∆t 的时间,目标右装甲板位置 (Xrnew,Yrnew) 的计 算如式(14)所示。目标后装甲板位置 (Xbnew,Ybnew) 的计 算如式(15)所示。
ì í î
ï
ï
Xrnew = XC + V·∆t· cos(θV) + L1· sin( )
θR + ω·∆t Yrnew = YC + V·∆t· sin(θV ) - L1· cos( )
θR + ω·∆t (14)
ì í î
ï
ï
Xbnew = XC + V·∆t· cos(θV ) - L2· cos( )
θR + ω·∆t Y
bnew = YC + V·∆t· sin(θV ) - L2· sin( )
θ
R + ω·∆t (15)
当下一帧有效数据到来时,会产生一个观测。如 果是右侧装甲板的位置观测 (XrO,YrO) ,则通过卡尔曼滤 波 将 观 测 状 态 PrO = (XrO, YrO) 与 预 测 状 态 Prnew = (Xrnew, Y
rnew) 进行融合,如式(16)所示。 P
r(Xr, Yr) = Prnew + K(PrO - Prnew) (16) 其中 K = F(F + R)-1 ,为卡尔曼增益。 F 为状态 Prnew 的协方差矩阵,R 为观测噪声的协方差矩阵,在实践中 可以通过距离调整 R 的值,因为一般来说距离越远其 观测误差越大。使用卡尔曼滤波进行状态更新可以使 得控制信号更加连贯,也使得位置数据更新更加平滑。
3 结语
本文给出了基于运动学建模的自动瞄准系统。相 较于传统自瞄算法,该算法对观测数据做到了更好的 利用。通过对目标车进行运动学建模,预测和射击不 用局限于同一块装甲板,从而大幅提升了实际效果。 最后通过卡尔曼滤波使得控制更加平滑。该自瞄系统 在比赛中表现良好,具有一定的实际意义。
参考文献:
[1]KUCUK S,BINGUL Z. Robot kinematics:Forward and inverse kinematics[M]. INTECH Open Access Publisher,2006. [2]PARK F C. Computational aspects of the product- of- exponentials formula for robot kinematics[J]. IEEE Transactions on Automatic Control,1994,39(3):643-647. [3]ASPRAGATHOS N A,DIMITROS J K. A comparative study of three methods for robot kinematics[J]. IEEE Transactions on Systems, Man,and Cybernetics,Part B(Cybernetics),1998,28(2):135-145. [4]MUIR P F,NEUMAN C P. Kinematic modeling for feedback control of an omnidirectional wheeled mobile robot[M]. Autonomous Robot Vehicles. Springer,New York,NY,1990:25-31. [5]GONZALEZ R C. Digital image processing. 3rd Edition,Prentice Hall,New Jersey,2007.
􀀡 􀀭


研究与开发
现代计算机(www.moderncomputer.cn) 2020.12 下
Automatic Aiming System Based on Kinematics Modeling
SONG Xun, MA Zhi-bo
(Department of Automation, Xi'an Jiaotong University, Xi'an 710049)
Abstract:
The RoboMaster National Robot Competition is a robotic competition. In the competition, the robots of both sides need to accurately strike specific parts of the opponent's robot with projectiles. In recent years, many participating teams have realized the importance of equipping robots with automatic aiming systems, and each team has also taken certain measures against automatic aiming. The traditional automatic aiming system adopted by most teams will fail when facing anti-auto-aim measures. Therefore, aiming at the technical principle of anti-au⁃ to-aim measures, an automatic aiming system based on Kinematics modeling is proposed, which can make up for the defects of traditional automatic aiming systems. Keywords:
Automatic Aiming; Anti-Auto-Aim; Kinematics
[6]MUIR P F,NEUMAN C P. Kinematic modeling of wheeled mobile robots[J]. Journal of Robotic Systems,1987,4(2):281-340. [7]WELCH G,BISHOP G. An introduction to the Kalman filter[J],1995. [8]HOSHIYA M,SAITO E. Structural identification by extended Kalman filter[J]. Journal of Engineering Mechanics,1984,110(12):17571770. [9]THRUN S. Probabilistic robotics[J]. Communications of the ACM,2002,45(3):52-57. [10]REDMON J,DIVVALA S,GIRSHICK R,et al. You only look once:Unified,real-time object detection[C]//Proceedings of the IEEE conference on computer vision and pattern recognition,2016:779-788.
作者简介:
宋珣(1999-),男,山西大同人,本科,研究方向为计算机视觉 马智博(1999-),男,山西大同人,本科,研究方向为飞行器导航与控制 收稿日期:2020-08-18 修稿日期:2020-10-18
􀀡􀀮