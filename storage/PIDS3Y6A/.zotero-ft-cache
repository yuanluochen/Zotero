第 43 卷 第 11 期 兵 器 装 备 工 程 学 报 2022 年 11 月 ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
收稿日期:2021 - 11 - 16;修回日期:2021 - 12 - 20
基金项目:教育部产学合作协同育人项目(201902252061)
作者简介:王洪玺(2001—) ,男,E⁃mail:wanghongxi2001@ foxmail. com。 通信作者:张兰勇(1983—) ,男,博士,教授,E⁃mail:zhanglanyong@ hrbeu. edu. cn。
doi: 10. 11809 / bqzbgcxb2022. 11. 041
基于卡尔曼滤波的目标识别跟踪与射击系统设计
王洪玺1 ,计泽贤2 ,张兰勇1
(1. 哈尔滨工程大学 智能科学与工程学院, 哈尔滨 150001;
2. 哈尔滨工程大学 机电工程学院, 哈尔滨 150001)
摘要:以 RoboMaster 全国大学生机器人大赛哈尔滨工程大学机器人自瞄系统为例,设计了基于最优估计理论的目标
识别跟踪与射击系统。 该系统包含目标识别与位置解算、云台姿态估计、目标运动预测与弹道补偿、云台运动控制
等 4 个部分。 利用 OpenCV 实现目标识别与单目位置解算,建立了卡尔曼滤波器估计目标运动与云台姿态,结合弹
道模型实现高精度运动预测,并基于串级反馈控制系统设计了云台运动控制器,实现发射初速度 15 m / s 弹丸击中目
标。 试验结果表明:该系统在 4 m 有效距离内对匀速目标命中率为 95. 37% ,综合机动目标命中率为 68. 27% 。
关键词:目标识别;机动目标跟踪;卡尔曼滤波;状态估计;串级控制
本文引用格式:王洪玺,计泽贤,张兰勇. 基于卡尔曼滤波的目标识别跟踪与射击系统设计[ J]. 兵器装备工程学报,
2022,43(11) :286 - 296.
Citation format:WANG Hongxi, JI Zexian, ZHANG Lanyong. Design of target recognition tracking and attack system based
on Kalman filter[ J] . Journal of Ordnance Equipment Engineering,2022,43(11) :286 - 296.
中图分类号:TP249 文献标识码:A 文章编号:2096 - 2304(2022)11 - 0286 - 11
Design of target recognition tracking
and attack system based on Kalman filter
WANG Hongxi1 , JI Zexian2 , ZHANG Lanyong1
(1. College of Intelligent Science and Engineering, Harbin Engineering University, Harbin 150001, China;
2. College of Mechanical and Electrical Engineering, Harbin Engineering University, Harbin 150001, China)
Abstract: A target recognition tracking and shooting system based on optimal estimation theory was
designed based on the RoboMaster robotics competition of Harbin Engineering University robot aim⁃assist
system as an example. The system contains four parts: target recognition and position solving, gimbal
attitude estimation, target motion prediction and ballistic compensation, and gimbal motion control.
OpenCV was used to realize target recognition and monocular position solving. Kalman filter was
established to estimate target motion and gimbal attitude, combined with ballistic model to realize high
precision motion prediction, and gimbal motion controller was designed based on serieslevel feedback
control system to achieve the firing initial velocity of 15 m / s projectile to hit the target. The test results
show that the hit rate of the system in this paper is 95. 37% for the uniform velocity target and 68. 27% for
the integrated maneuvering target within 4 m effective distance.
Key words: target recognition; maneuvering target tracking; Kalman filter; state estimation; cascade control


1 引言
在当今军事领域和科技领域中,机动目标的识别、跟踪
具有广泛应用。 设计目标跟踪系统主要分为建立目标的运
动状态模型和设计估计器进行滤波估计[1 -2] 。 一般常用卡
尔曼滤波器等最优估计算法,文献[3] 中利用 EKF 对地理坐
标系下静止目标具有较好的定位效果,文献[4] 中利用匀速
( CV) 模型建立 EKF 实现对运动目标的跟踪。 匀速模型,假
设目标匀速直线运动,将加速度建模为随机过程噪声,结构
简单、计算量小。 文献[5] 利用自适应高阶容积卡尔曼滤波
器与匀速转弯模型对“S”型平面飞行目标具有相比于 3 阶容
积卡尔曼滤波器更高的跟踪精度与更快的收敛速度。 本文
系统跟踪的目标通常机动较弱,采用匀速模型构建卡尔曼滤
波器,可以极小的运算量取得较好的跟踪效果。
目标跟踪过程中坐标变换矩阵需通过惯导姿态解算获
得。 文献[6]中通过 4 元数微分方程更新姿态,并利用加速
度计测量值修正姿态 4 元数。 但加速度测量值中的运动加
速度会影响修正准确性,针对此问题,本文云台姿态估计算
法融合陀螺仪与加速度计信息估计重力加速度,并利用估计
得到的重力加速度通过非线性约束更新对 4 元数进行修正,
可较大程度减小运动加速度对姿态解算的影响,同时对加速
度量测噪声有较好的抑制作用。
2 系统结构
RoboMaster 机甲大师赛要求双方操作手操控机器人通
过云台瞄准,并使用摩擦轮发射弹丸打击对方机器人装甲
板,如图 1 所示。 因此,高性能的目标识别与跟踪系统在比
赛中尤为重要。 文献[7]中自瞄系统具有远优于操作手人为
瞄准的性能,并在比赛中有出色表现。 本文以 RoboMaster 机
甲大师赛为研究背景,设计出基于最优估计理论的目标识别
跟踪与射击系统。
图 1 机器人发射 17 mm 弹丸击打装甲板场景图
Fig. 1 Robot fires 17 mm projectile to hit armor
本文系统通过与云台固联的相机采集画面,机载 miniPC
根据目标外观特征利用 OpenCV 识别目标装甲板,并通过
Perspective⁃n⁃Point ( PnP) 解算出目标在相机坐标系中的位
置。 相机选用分辨率 640 ∗360、帧率 330FPS 的 USB2. 0 相
机,miniPC 处理器为酷睿 i7⁃8550U。
miniPC 解算出目标装甲板相机系坐标后,通过串口发送
给下位机,下位机以 STM32F407IGH6 为核心处理器、BMI088
为云台 IMU。 根据相机与云台 IMU 的相对位置与姿态可得
到目标在云台坐标系中的位置后,通过云台姿态估计确定的
坐标变换矩阵得到目标的惯性系位置。 得到目标惯性系位
置后,利用匀速模型卡尔曼滤波器估计目标在惯性系的运动
状态,即位置与速度。 云台姿态估计与目标运动状态估计中
卡尔曼滤波器均利用 CMSIS DSP 矩阵运算库实现。
最后根据目标运动状态与弹道模型实现运动预测与弹
道补偿,进而得到云台的期望姿态角。 在串级控制器基础上
设计的云台控制系统实现对目标的跟踪与打击。 云台电机
采用 GM6020 直流无刷电机,下位机通过 CAN 总线向电机驱
动器发送控制指令控制其输出电压。 系统结构如图 2 所示。
图 2 系统结构框图
Fig. 2 System architecture
3 目标识别与位置解算
3. 1 目标外观特征
装甲板具有明显外观特征,矩形装甲板边缘具有 2 条平
行发光灯条,其会根据队伍红蓝方发出红色或蓝色亮光,如
图 3 所示。
图 3 目标外观特征图
Fig. 3 Target appearance characteristics
3. 2 目标识别过程
首先利用 OpenCV 中 split 函数提取对应颜色的色彩通
287
王洪玺,等:基于卡尔曼滤波的目标识别跟踪与射击系统设计
■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■


道并根据灰度值寻找灯条。 为避免白光干扰,使目标灯条颜
色通道的灰度图减去绿色通道灰度图,得到剔除白光的灰度
图。 后对灰度图进行二值化,利用 OpenCV 中 findContours 函
数在二值图中寻找轮廓,再通过最小外接矩形拟合轮廓点集
得到灯条轮廓旋转矩形框。 为避免在复杂背景环境下可能
存在的误识别,通过拟合得到的旋转矩形长宽比、倾斜角与
轮廓面积比等几何约束筛选掉画面当中非灯条的发光物体,
识别处理过程如图 4 所示。
图 4 识别处理过程图
Fig. 4 Identification process
3. 3 灯条匹配与 PnP 位置解算
得到灯条后,通 过 装 甲 板 几 何 特 征 对 灯 条 两 两 匹 配, 以
得到装甲板角点。 设每次取出的 2 个灯条矩形的 4 个角点
分别为{ p00 ,p01 ,p02 ,p03 } ,p10 ,p11 ,p12 ,p13 ,顺序为左下、左上、
右上、右下,矩形中心分别为 p0c 、p1c 。 令:
v1 = p00 - p01
v2 = p10 - p11
v3 = p0c - p1c
l1 = | p00 - p01 |
l2 = | p10 - p11 |
l3 = | p0c - p1c |
■
■
■
| | ||
| | ||
组成装甲板的一对灯条,应满足条件:
v1
v1
· v2
v2
> C0
v1
v1
· v3
v3
< C1
C2 < l3
min l1 ,l2
{ } < C3
1 ≤ max l1 ,l2
{}
min l1 ,l2
{ } < C4
■
■
■
| | |
||
| | | ||
(1)
式(1) 中:C0 = 0. 994 5,描述 2 灯条角度差应小于 6°;C1 =
0. 35,描述 2 灯条连接端点后应接近矩形而非平行四边形;
C2 = 1. 25,C3 = 5 描述 2 灯条间距应在一定范围内;C4 = 1. 5,
描述 2 灯条长度比应在一定范围内。
灯条匹配完成后延长灯条即可得到装甲板 4 个角点,如
图 5 所示。
根据装甲板 4 个角点在像平面坐标与装甲板实际尺寸,
与预先标定得到的相机内参矩阵与畸变参数,通过 PnP 算法
即可解算出装甲板中心在相机系的坐标 rc = [ xc ,yc ,zc ] T 。
图 5 装甲板角点图
Fig. 5 Armor corner point
4 云台姿态估计
云台姿态估计用于求解云台系到惯性系的坐标变换矩
阵与姿态欧拉角,准确的姿态信息对目标运动估计和云台运
动控制至关重要。
4. 1 坐标系定义
1) 云台坐标系( b 系)。 云台坐标系三轴与载体固联,
三轴分别与云台 IMU 三轴平行,记为 OXbYbZb。
2) 相机坐标系(c 系)。 相机坐标系与云台坐标系相对静
止,其变换关系由相机安装位置与姿态决定,记为 OXcYcZc。
3) 惯性坐标系(n 系)。 惯性坐标系各轴相对惯性空间
的指向保持不变,记为 OXnYnZn。
4. 2 姿态描述
姿态描述的是云台坐标系 ( b 系) 相对惯性坐标系 ( n
系)的旋转关系。 常见的描述方法有 3 种,每种各有其优缺
点,本节将给出欧拉角、4 元数 2 种姿态描述方法。
4. 2. 1 姿态角
姿态角是一种常用且直观的姿态描述方法,几何意义明
确,因此在姿态控制中被广泛应用。 机体姿态即 b 系是由 n
系经过转动顺序为 z - x - y,转角分别为 ψ、θ、γ 的 3 次旋转
得到,其中 ψ、θ、γ 分别为航向角( Yaw) 、俯仰角( Pitch) 、横滚
角( Roll) 。
4. 2. 2 4 元数
4 元数可定义为:
q = q0 + q1 i + q2 j + q3 k( q0 ,q1 ,q2 ,q3 ∈ R) (2)
式(2) 中, i2 = j2 = k2 = ijk = - 1。 4 元数可以看作基{1,i, j,
k} 的线性组合,因此,4 元数也可以写成向量形式,即:
q=
q0
q1
q2
q3
■
■
| | | ||
■
■
| | | ||
单位 4 元数可用于描述姿态,通过 4 元数表示的 b 系到
288 兵 器 装 备 工 程 学 报 http: / / bzxb. cqut. edu. cn / ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■


n 系的坐标变换矩阵 Cn
b 为:
Cn
b=
1 - 2( q2
2 + q2
3 ) 2( q1 q2 - q0 q3 ) 2( q1 q3 + q0 q2 )
2( q1 q2 + q0 q3 ) 1 - 2( q2
1 + q2
3 ) 2( q2 q3 - q0 q1 )
2( q1 q3 - q0 q2 ) 2( q2 q3 + q0 q1 ) 1 - 2( q2
1 + q2
2)
■
■
| | |
■
■
| | |
4 元数关于时间的微分方程为:
q= 1
2 Ωq (3)
式(3) 中:
Ω=
0 - ωx - ωy - ωz
ωx 0 ωz - ωy
ωy - ωz 0 ωx
ωz ωy - ωx 0
■
■
| | | ||
■
■
| | | ||
(4)
式(4) 中, ωx 、ωy 、ωz 为 b 系相对 n 系的角速度。
4. 3 过程模型
4. 3. 1 4 元数状态空间方程
对 4 元数微分方程 q = 1
2 Ωq 以 Δt 步长进行离散化,有:
qk+1 = qk + qk Δt = ( I4 ×4 + 1
2 ΩkΔt)qk
记矩阵 Fq
k = I4 × 4 + 1
2 Ωk Δt,得到 4 元数离散时间形式状态空
间方程为:
qk+1 = Fq
k qk
4. 3. 2 重力加速度状态空间方程
机体坐标系(b 系) 下的重力加速度单位向量为:
g = Cb
n
0
0
1
■
■
| ||
■
■
| ||
对时间 t 求导,得:
g = - Cb
n(ω ×)
0
0
1
■
■
| ||
■
■
|
|| (5)
式(5) 中,矩阵 ω × 为 b 系相对 n 系的角速度 ω = [ ωx , ωy ,
ωz] T 构成的反对称阵:
(ω ×) =
0 - ωz ωy
ωz 0 - ωx
- ωy ωx 0
■
■
| | |
■
■
| | |
为保证模型精度,根据罗德里格公式 Cb(k +1)
n = Cb(k +1)
b(k) Cb(k)
n,
得离散时间状态空间方程为:
gk+1 = Cb(k+1)
b(k) gk (6)
式(6) 中:
Cb(k +1)
b(k) = I3 ×3 - sin Δθk
Δθk
(Δθk ×) + 1 - cos Δθk
| Δθk | 2 ( Δθk ×)2
(7)
式( 7 ) 中, Δθk 为 k 周 期 的 陀 螺 仪 输 出 角 增 量, 即 Δθk
= ωkΔt。
记矩阵 Fg
k = Cb(k + 1)
b(k) ,得到重力加速度单位向量离散时间
形式状态空间方程为:
gk+1 = Fg
k gk
4. 3. 3 系统状态与过程模型
综上,定义状态向量为:
x= q
[g] (8)
式(8) 中: q = [ q0 ,q1 ,q2 ,q3 ] T 为机体坐标系 ( b 系) 相对惯
性坐标系( n 系) 的姿态四元数; g = [ gx ,gy ,gz ] T 为重力加速
度在机体坐标系下的单位向量,即满足 | g | = 1。
过程模型为:
xk+1 = Fk xk + wk , wk ~ N(07 ×1 ,Q) (9)
式(9) 中:
Fk = Fq
k 04 ×3
03 ×4 Fg
k
■
■
||
■
■
||
4. 4 量测模型
量测模型为:
zk = Hk xk + vk , vk ~ N(03×1 , Rk )
采用归一化后的加速度计测量值 a = 1 / a2
x + a2
y + a2
z·
[ ax ,ay ,az ] T 作为量测向量,则:
Hk =
0000100
0000010
0000001
■
■
| ||
■
■
| ||
定义误差 ek:
ek = x
k × ak
并根据误差 ek 与加速度大小 a2
x + a2
y + a2
z 动态调整量
测噪声矩阵:
1) 当 | ek | < a1 时,认为系统不处于机动状态,加速度量
测具有较高可信度,因此量测噪声矩阵 Rk 保持原始值即可。
2) 当 a1 < | ek | < a2 时,系统机动使加速度量测与估计值
相差较大,应适当增大量测噪声矩阵 Rk 。
3) 当 | ek | > a2 或 a2
x + a2
y + a2
z >> 9. 8 时,系统机动过
大,应设置量测噪声矩阵 Rk 为无穷大。
4. 5 状态约束卡尔曼滤波器
传统卡尔曼滤波包含以下 5 个基本公式。
1) 过程更新:
x
k = Fk xk-1
2) 先验估计误差协方差更新:
P
k = Fk Pk-1 FT
k +Q
3) 计算卡尔曼增益:
Kk = P
k HT
k (HkP
k HT
k + Rk ) -1
4) 量测更新:
xk = x
k + Kk(zk - Hkx
k)
5) 后验估计误差协方差更新:
Pk = (I - KkHk)P
k
有些系统除了过程模型描述的系统动态以外,还包含各
289
王洪玺,等:基于卡尔曼滤波的目标识别跟踪与射击系统设计
■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■


种各样的约束。 这些约束运用得当可以有助于提高滤波精
度。 其中等式约束可以类似量测更新的形式进行约束更
新[8] 。 设系统存在等值约束为:
Dx = b
利用此约束,可对后验估计结果 xk 进行约束更新,即:
xc
k = xk + Kc
k ( bk - Dk xk ) (10)
式(10) 中,约束更新增益:
Kc
k = PkDT
k (DkPkDT
k ) -1
若等值约束存在不确定性,则:
Kc
k = PkDT
k (DkPkDT
k + Rc ) -1 (11)
式(11) 中, Rc 为等值约束中不确定性的方差阵。 经过约束
更新后,状态误差协方差矩阵为:
Pc
k = (I - Kc
k Dk ) Pk
对于非线性状态约束:
g(x) = b
有:
xc
k = xk + Kc
k(bk - g(xk))
Dk =
∂g( xk )
∂xk
4. 6 约束模型
姿态更新过程中需通过估计得到的重力加速度向量对
姿态 4 元数进行修正。 另外,在更新过程中需保持 4 元数的
单位性质。 它们均可看作系统的约束,即可以通过约束更新
实现 4 元数姿态修正与归一化。
4. 6. 1 重力加速度向量约束模型
根据 4 元数构成的坐标转换矩阵 Cb
n ,有:
g = Cb
n
0
0
1
■
■
| ||
■
■
|
|| (12)
式(12) 中,Cb
n = CnT
b 。 即存在约束:
2( q1 q3 - q0 q2 )
2( q2 q3 + q0 q1 )
1 - 2( q2
1 + q2
2)
■
■
| ||
■
■
|
|| =
gx
gy
gz
■
■
| | |
■
■
| | |
其中 q0 ,q1 ,q2 ,q3 ,gx ,gy ,gz 为后验估计值 xk 中状态变量,设:
g1 ( xk ) =
2( q1| k q3| k - q0| k q2| k )
2( q2| k q3| k + q0| k q1| k )
1 - 2( q2
1| k + q2
2| k )
■
■
| | |
■
■
| | |
, b1 =
gx| k
gy| k
gz| k
■
■
| | |
■
■
| | |
有:
D1k = ∂g1 ( xk )
∂xk
=
- 2q2| k 2q3| k - 2q0| k 2q1| k
2q1| k 2q0| k 2q3| k 2q2| k
2q0| k - 2q1| k - 2q2| k 2q3| k
■
■
| | |
■
■
| | |
另外,重力加速度向量垂直于惯性系,不能用于修正航
向角。 为避免修正过程破坏航向角准确性,修正值 Kc1
k ( b1 
g1 ( xk ) ) 不能用于修正状态变量 q3 ,故对于此约束更新( 定义
为约束更新 1) ,其增益 Kc1
k 为:
Kc1
k = MPk DT
1k ( D1k Pk DT
1k + Rc
1 ) -1 (13)
式(13) 中,矩阵 M 为:
M1 = I3 ×3 03 ×4
04 ×3 04 ×4
[]
4. 6. 2 单位 4 元数约束模型
根据单位 4 元数性质,存在约束:
q2
0 + q2
1 + q2
2 + q2
3 = 1 (14)
式(14) 中,q0 ,q1 ,q2 ,q3 为姿态修 正 后 状 态 xck1 中 的 4 四 元
数。 设:
g2 ( xc1
k ) = q2
0| k + q2
1| k + q2
2| k + q2
3| k , b2 = 1
有:
D2 k = ∂g1 ( xc1 )
∂xk
c1 k
= 2q0| k 2q1| k 2q2| k 2q3| k 01 ×3
[]
综上,云台姿态估计的状态约束卡尔曼滤波器实现更新
流程如图 6 所示。
图 6 云台姿态估计算法更新流程框图
Fig. 6 Flowchart for updating the gimbal attitude
estimation algorithm
5 目标运动预测与弹道补偿
云台发射的 17 mm 弹丸初速度约为 15 m / s,飞行时间无
法忽略不计。 因此在云台跟踪目标的过程中需要对目标运
动进行预测,从而确定云台期望姿态角。 为保证运动预测合
理性,选取惯性坐标系( n 系) 对目标运动状态进行估计与预
测。 利用匀速直线模型设计卡尔曼滤波器,以估计目标在惯
性系的位 置 与 速 度, 并 通 过 卡 方 检 验 判 断 目 标 是 否 发 生
切换。
5. 1 目标运动状态估计
5. 1. 1 坐标变换
设由 miniPC 解 算 出 目 标 在 相 机 坐 标 系 ( c 系) 的 坐
标为:
290 兵 器 装 备 工 程 学 报 http: / / bzxb. cqut. edu. cn / ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■


rc =
xc
yc
zc
■
■
| | |
■
■
| | |
根据相机的安装位置,目标在云台坐标系(b 系) 的坐标
可由 rc 经过旋转平移后得到:
rb =
xb
yb
zb
■
■
| | |
■
■
| | |
= Cb
c rc + tb
c (15)
式(15) 中: Cb
c 为旋转矩阵; tb
c 为平移向量,可通过标定得
到,一般为定值。
考虑到目标坐标与姿态信息时间上并不同步,需根据其
时间戳确定两者时间偏移关系。 由于图像采集耗时 3 ms、目
标识别与解算耗时 1 ~ 3 ms,因此需根据时间偏移关系从历
史姿态信息中找出与目标坐标时间对应的 4 元数,利用该 4
元数构成的坐标变换矩阵 Cn
b,将目标坐标由云台系 (b 系)
转换至惯性系(n 系),即:
rn =
xn
yn
zn
■
■
| | |
■
■
| | |
= Cn
b rb
5. 1. 2 运动模型
采用匀速模型描述目标在惯性系的运动,即:
d dt
x
[x]= 0 1
00
[ ]x
[x]+ 0
[1 ]w(t) (16)
式(16) 中,w( t) ~ N(0,σ2 ) 。 其离散时间形式为:
xk+1 = 1 Δt
01
[ ]xk +
1
2 Δt2
Δt
■
■
| |
■
■
|
|wk
5. 1. 3 过程模型
利用匀速模型设计卡尔曼滤波器,以估计目标在惯性系的位
置与速度,设状态为:
x=
xn
xn
yn
yn
zn
zn
■
■
| | | | | | ||
■
■
| | | | | | ||
过程模型为:
xk+1 = Fk xk + Γk wk , wk ~ N(03 ×1 ,Qk )
其中:
Fk =
1 Δt 0 0 0 0
010000
0 0 1 Δt 0 0
000100
0 0 0 0 1 Δt
000001
■
■
| | | | | ||
■
■
| | | | | ||
Γk =
1
2 Δt2 0 0
Δt 0 0
01
2 Δt2 0
0 Δt 0
0 01
2 Δt2
0 0 Δt
■
■
| | | | | | | | | |
■
■
| | | | | | | | | |
过程噪声方差阵 Qk为:
Qk =
σ2
x0 0
0 σ2
y0
0 0 σ2
z
■
■
| | |
■
■
| | |
(17)
式(17) 中,σ2
x 、σ2
y 、σ2
z 分别为 x、y、z 三轴过程噪声方差。
5. 1. 4 量测模型
量测模型如下:
zk = Hkxk + vk
采用目标惯性系坐标 rn = [ xn, yn, zn ]T 作 为 量 测 向
量,则:
Hk =
100000
001000
000010
■
■
| ||
■
■
|
||, vk ~ N(03 ×1 ,Rk )
相机模型如图 7 所示。
图 7 相机模型示意图
Fig. 7 Camera model
定义目标相机系坐标 rc 与 yOz,xOz 平面夹角分别为:
α = actan( xc / zc ) , β = actan( yc / zc ) ,有:
rc =
xc
yc
zc
■
■
| | |
■
■
| | |
= g( zc ,α,β) =
zc tanα
zc tanβ
zc
■
■
| | |
■
■
| | |
记原始量测 zr = [ zc ,α,β] T 。 像平面中像的大小由欧式
距离决定,但考虑到相机视场角较窄,为简化模型,可假设 zc
决定目标像平面大小,三者相互独立,方差分别为 σ2
z 、 σ2
α、
σ2
β ,其噪声方差阵 Rr 为:
Rr =
σ2
z0 0
0 σ2
α0
0 0 σ2
β
■
■
| | |
■
■
| | |
291
王洪玺,等:基于卡尔曼滤波的目标识别跟踪与射击系统设计
■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■


对 rc = g( zc,α,β) 在工作点处线性化,得到 k 时刻相机
系坐标噪声方差阵 Rc
k 为:
Rc
k = GkRrGT
k
其中:
Gk = ∂g( zr
k) ∂zr
k
=
tanαk
zc| k
cos2 αk
0
tanβk 0 zc| k
cos2 βk
10 0
■
■
| | | | |
■
■
| | | | |
根据 rb = Cb
c rc + tb
c ,旋转矩阵 Cb
c 接近单位阵,平移向量 tb
c
为确定常量,则 k 时刻云台系坐标噪声方差阵 Rb
k 与相机系
坐标噪声方差阵 Rc
k 相等,即:
Rb
k = Rc
k
根据 rn = Cn
b rb ,k 时刻惯性系坐标噪声方差阵 Rn
k 为:
Rn
k = Cn
b| k Rb
k CnT
b| k
则 k 时刻滤波器量测噪声方差阵为:
Rk = Cn
b| k Gk Rr GT
k CnT b| k
miniPC 中目标识别与解算的频率约为 300 Hz,而单片机
中卡尔曼滤波器更新频率为 1 kHz。 因此并非每个卡尔曼滤
波器更新周期中 miniPC 都能解算出的坐标,故仅在 miniPC
解算出坐标的周期进行量测更新,否则只进行过程更新,即
异步量测[9] 。
5. 1. 5 卡方检验
若跟踪过程中 miniPC 识别的目标发生了切换,卡尔曼
滤波器得到的位置量测会与当前位置估计有显著差异,直接
进行量测更新会得到一个极大的速度估计值。 为解决该问
题,本文系统通过卡方检验判断跟踪目标是否发生变化。 定
义残差:
ek = zk - Hkx
k
正常情况下,残差 ek 符合期望为 0 的正态分布,其方
差为:
Dk = E[ ek eT
k ] = HkP
k HT
k + Rk
当发生目标切换时,残差的值会显著大于正常情况,定
义检测函数为:
rk = eT
k D -1
k ek
若 rk 大于阈值,说明位置量测与位置先验估计值有较大
差别,即发生了目标切换。 发生目标切换后,应对状态及其
协方差矩阵进行复位以迅速重新收敛,即:
Pk = P0
xk = Gzk
其中:
G=
100
000
010
000
001
000
■
■
| | | | | ||
■
■
| | | | | ||
综上,运动状态估计中卡尔曼滤波器更新流程如图 8
所示。
图 8 目标运动估计流程框图
Fig. 8 Flow chart of target motion estimation
5. 2 弹道模型与弹道补偿
得到目标惯性系下的位置与速度估计后,通过弹道模型
计算弹丸 飞 行 时 间, 从 而 确 定 运 动 预 测 步 长 与 弹 道 下 坠
补偿。
5. 2. 1 弹道模型
一般情况下 17 mm 弹丸发射角度接近水平,因此竖直方
向速度分量极小,故忽略竖直方向空气阻力,仅考虑水平方
向空气阻力对弹丸的作用。 设弹丸水平方向受到的空气阻
力大小与速度平方成正比: f = kv2
x,则水平方向动力学模
型为:
- kv2
x = m dvx
dt
根据初始条件 vx(0) = vx|0 解得:
vx ( t) = vx| 0
k1 vx| 0 t + 1 (18)
式(18) 中,k1 = k / m。 水平速度 vx ( t) 对时间 t 积分得水平
位移 x(t),有:
x(t) = ∫t
0
vx(τ)dτ = 1
k1
ln( k1 vx| 0 t + 1)
根据位置估计值可得到目标水平距离 x 与水平速度 x,
则弹丸飞行时间 T 满足:
x + xT = 1
k1
ln( k1 vx| 0 T + 1)
利用牛顿迭代求解飞行时间 T,定义函数为:
f(t) = 1
k1
ln( k1 vx| 0 t + 1) - x - xt
有:
292 兵 器 装 备 工 程 学 报 http: / / bzxb. cqut. edu. cn / ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■


f ′( t) = vx| 0
k1 vx| 0 t + 1 - x
迭代公式为:
T0 = 0
Tk+1 = Tk - f( Tk )
f ′( Tk )
综上,云台应瞄准经过 T + τs 后目标位置,其中 τ 为相
机图像采集与传输延时、图像处理与通信延时、控制器跟随
延时之和,即期望航向角 ψ 为:
ψ = actan yn + yn(T + τ)
xn + xn(T + τ)
5. 2. 2 弹道补偿
由于弹丸飞行过程中会受重力作用发生下坠,因此,为
使弹丸击中目标云台,应上抬相应角度。 简单起见,本文系
统采用比例补偿器进行迭代求解。 根据弹丸飞行时间 T、弹
丸初速度 v0 、迭代初始俯仰角 θ0 可求得弹丸落点高度 h0 为:
h0 = v0 sinθ0 T - 9. 8
2 T2
根据运动状态估计值可得到目标实际高度 hr = zn + znT,
定义误差 ek:
ek = hr - hk (19)
式(19) 中,hk 为第 k 次迭代落点高度。
弹道补偿过程如图 9 所示。
图 9 弹道补偿迭代流程框图
Fig. 9 Ballistic compensation iteration flow chart
6 云台控制系统设计
用于打击目标的 17 mm 弹丸由固联于云台的摩擦轮进
行发射,因此设计合理的控制系统,使云台具有足够好的响
应速度与精度是高命中率的先决条件。
6. 1 云台模型
本系统通过电压驱动云台电机,根据电机模型可建立关
于电压 u、电流 i、转速 ωa 、ωe 的微分方程,即:
Kti(t) = J ωa(t) + bωr(t)
u( t) = Ke ωr ( t) + Ri( t) + L· i( t)
ωa(t) = ωr(t) + ωe(t)
(20)
式(20) 中:Kt 为转矩常数;Ke 为反电动势常数; J 为负载转动
惯量;b 为阻尼系数;R 为电阻;L 为电感;ωe 为底盘相对惯性
系角速度,为电机角速度;ωa 为云台相对惯性系角速度。 拉
普拉斯变换可得:
KtI(s) = JsΩa(s) + bΩr(s)
U(s) = KeΩr(s) + RI(s) + LsI(s)
Ωa(s) = Ωr(s) + Ωe(s)
进一步计算可得:
Ωr(s) = KtI(s) - JsΩe(s)
Js + b
I(s) = U(s) - KeΩr(s)
Ls + R
(21)
根据式(21) 得到其系统框图,如图 10 所示。
图 10 电机模型框图
Fig. 10 Block diagram of motor model
6. 2 控制器设计
根据该模型,设计串级反馈控制器,如图 11 所示。
图 11 串级控制器框图
Fig. 11 Block diagram of the cascade controller
图 11 中,CΘ ( s) 、CΩ ( s) 、CI ( s) 分别为角度环 PD 控制
器、速度环 PI 控制器、电流环 PI 控制器。 图 11 中云台绝对
角速度 Ωa(s)为:
Ωa(s) = Ωe(s) + Ωr(s) = Ωe(s) + KtI(s) - JsΩe(s)
Js + b =
KtI(s) + bΩe(s) Js + b
为减小底盘运动 Ωe(s)对云台姿态控制的影响,设计补
偿器,使得:
Kt I( s) + bΩe ( s) = Kt Ccl ( s) X( s) (22)
式(22) 中: Ccl ( s) 为电流环闭环传递函数;X( s) 为速度环 PI
控制器输出。 解得电流 I(s)为:
I( s) = Ccl ( S) X( s) - b
Kt
Ωe ( s)
应用该补偿器,控制系统如图 12 所示。
293
王洪玺,等:基于卡尔曼滤波的目标识别跟踪与射击系统设计
■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■


图 12 云台控制系统框图
Fig. 12 Block diagram of gimbalcontrol system
图 12 中,底盘运动 Ωe ( s) 由安装在机器人底盘的 IMU
直接测得,补偿后云台绝对角速度 Ωa ( s) 为:
Ωa ( s) = Kt I( s) + bΩe ( s)
Js + b =
Kt X(s) - bn
Kn
Ωe ( s)
( )Ccl(s) + bΩe(s)
Js + b =
Kt X( s) Ccl ( s) + b - Kt
bn
Kn
Ccl ( s)
( )Ωe(s)
Js + b (23)
由于 电 流 环 闭 环 系 统 带 宽 远 高 于 速 度 环, 低 频 段 有
Ccl ( s) = 1,故式(23) 可近似为:
Ωa(s) =
KtX(s) + b - Kt
bn
Kn
( )Ωe(s)
Js + b (24)
式(24) 中,bn = b, Kn = Kt ,由参数辨识确定。 理想情况下b 
Kt / Kn bn = 0,即该补偿器可完全补偿底盘运动对云台绝对角
速度的影响。
7 试验
7. 1 匀速机动
匀速机动试验使目标机器人以匀速直线运动通过,击打
效果如图 13 所示。 图 13 中蓝方机器人匀速通过红方机器
人击打区域,电脑屏幕实时显示红方机器人估计的目标装甲
板位置及其预测值。
图 13 击打匀速目标效果图
Fig. 13 Hitting even targets
目标惯性系坐标与预测结果如图 14 所示,图 14 中实线
为目标惯性系坐标,虚线为惯性系位置预测结果。 机器人云
台到目标的航向角及其预测结果如图 15 所示,图 15 中实线
为实际位置航向角,虚线为预测结果,即云台 Yaw 期望角度。
图 14 匀速机动目标惯性系坐标与预测结果曲线
Fig. 14 Homogeneous maneuvering target inertial system
coordinates and prediction results
图 15 匀速机动云台到目标航向角与预测结果曲线
Fig. 15 Homogeneous maneuvering head to target heading angle
with predicted results
预测结果与实际弹丸弹道均稳定超前于实际目标装甲
板位置,统计命中率 21 中 20,接近 100% 。 进行多次实验统
计命中率如表 1 所示,综合命中率为 95. 37% 。
表 1 匀速机动命中率统计
Table 1 Homogeneous maneuver hitting statistics
命中数 / 发 发弹量 / 发 命中率 / %
1 20 21 95. 24
2 17 17 100
3 18 19 94. 74
4 25 27 92. 59
5 23 24 95. 83
7. 2 综合机动
综合机动中,手持 2 块装甲板,在机器人击打区域内做
无规则机动,同时伴随 2 块装甲板的跟踪切换,以评估卡方
检验有效性与切换目标后滤波器收敛速度,并统计命中率。
目标惯性系坐标与预测结果如图 16 所示,图 16 中实线为目
294 兵 器 装 备 工 程 学 报 http: / / bzxb. cqut. edu. cn / ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■


标惯性系坐标,虚线为惯性系位置预测结果。 机器人云台到
目标的航向角及其预测结果如图 17 所示,图 17 中实线为实
际位置航向角,虚线为预测结果,即云台 Yaw 期望角度。
图 16 综合机动目标惯性系坐标与预测结果曲线
Fig. 16 Integrated maneuvering target inertial system
coordinates and prediction results
图 17 综合机动云台到目标航向角与预测结果曲线
Fig. 17 Integrated maneuvering head to target heading
angle with predicted results
在时间 t = 0. 67,2. 6,4. 0 s 时发生了目标切换,滤波器
迅速收敛,系统得到有效预测值。 统计命中率 53 中 37,为
69. 81% 。 进行多次实验统计命中率如表 2 所示,综合命中
率为 68. 27% 。
表 2 综合机动命中率
Table 2 Integrated mobile hitting statistics
命中数 / 发 发弹量 / 发 命中率 / %
1 37 53 69. 81
2 33 46 71. 74
3 45 66 68. 18
4 39 63 61. 90
5 44 62 70. 96
8 结论
1) 利用 PnP 方法,可准确解算出正对相机目标装甲板
的位置,为后续运动估计与预测提供了可靠的量测信息。
2) 利用状态约束卡尔曼滤波器估计云台姿态,可避免
机器人急起急停时的运动加速度破坏姿态估计精度,同时对
云台摩擦轮转动带来的振动噪声有较好的抑制作用。
3) 得益于 300 Hz 的识别频率,运动估计与预测具有较
高的收敛速度,即使采用匀速模型,仍能对做变速机动的目
标有较好的跟踪效果。
4) 在参数辨识准确情况下云台控制系统不易受底盘运
动的干扰,同时具有良好的响应速度与精度。
5) 本系统打击效果显著优于操作手人为瞄准,在 Robo⁃
Master 全国机器人大赛中有出色表现,应用本系统的哈尔滨
工程大学创梦之翼战队 2 台步兵机器人分别在 2021 赛季北
部赛区机器人实战奖中获得前 2 名。
参考文献:
[1] Li X R,Vesselin P. Survey of maneuvering target tracking.
Part I: Dynamic models [ J]. IEEE Transactions on Aero⁃
space and Electronic Systems,2003,39(04):1333 - 1362.
[2] 鲍阚. 智能车辆近场物体探测及其状态识别方法研究
[D]. 长春:吉林大学,2016.
Bao K. Research on near field object detection and state
recognition method of intelligent vehicle [ D]. Changchun:
Jilin University,2016.
[3] 李美红,尹健,徐劲祥. 基于 EKF 的机载光电吊舱目标
定位研 究 [ J]. 弹 箭 与 制 导 学 报, 2016, 36 ( 06 ): 157
- 161.
Li M H,Yin J,Xu J X. Research on target location of air⁃
borne photoelectric pod based on EKF[ J]. Journal of Mis⁃
sile and Guidance,2016,36(06):157 - 161.
[4] 王海军,刘进忙. 基于卡尔曼滤波的无源雷达目标跟踪
分析[J]. 战术导弹技术,2005(06):43 - 45.
Wang H J,Liu J M. Target tracking analysis of passive radar
based on Kalman filter [ J]. Tactical Missile Technology,
2005(06):43 - 45.
[5] 崔乃刚,张龙,王小刚,等. 自适应高阶容积卡尔曼滤波
在目标跟踪中的应用[ J]. 航空学报,2015,36(12):3885
- 3895.
Cui N G,Zhang L,Wang X G,et al. Application of adaptive
high order volume Kalman filter in target tracking[J]. Jour⁃
nal of Aeronautics,2015,36 (12):3885 - 3895.
295
王洪玺,等:基于卡尔曼滤波的目标识别跟踪与射击系统设计
■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■


[6] Sabatelli S, Galgani M, Fanucci L, et al. A double⁃stage
Kalman filter for orientation tracking with an integrated pro⁃
cessor in 9⁃D IMU[ J]. IEEE Transactions on Instrumenta⁃
tion and Measurement,2012,62(03):590 - 598.
[7] Tang X,Leng C,Guan Y,et al. Development of tracking and
control system based on computer vision for robomaster
competition robot[ C] / / Proc. of the 2020 5th International
Conference on Advanced Robotics and Mechatronics
(ICARM). IEEE,2020:442 - 447.
[8] Simon D. Kalman filtering with state constraints:A survey of
linear and nonlinear algorithms[ J]. IET Control Theory &
Applications,2010,4(08):1303 - 1318.
[9] 康国华,刘建业,熊智. 导航系统中量测滞后异步多传感
器集中滤波算法[J]. 东南大学学报(自然科学版),2005
(05):60 - 64.
Kang G H,Liu J Y,Xiong Z. Asynchronous Multisensor cen⁃
tralized filtering algorithm with measurement lag in naviga⁃
tion system [ J]. Journal of Southeast University ( Natural
Science Edition),2005(05):60 - 64.
[10] 张泊宁,杜忠华,鲍科. 基于机器视觉的二轴云台的目标
跟踪设计[J]. 电子设计工程,2019,27(12):152 - 157.
Zhang B N,Du Z H,Bao K. Target tracking design of two
axis pan tilt based on machine vision[J]. Electronic Design
Engineering,2019,27(12):152 - 157.
[11] 储开斌,赵爽,冯成涛. 基于 Mahony⁃EKF 的无人机姿态解
算算法[J]. 电子测量与仪器学报,2020,34(12):12 - 18.
Chu K B,Zhao S,Feng C T. UAV attitude solution algorithm
based on Mahony EKF[ J]. Journal of Electronic Measure⁃
ment and Instrumentation,2020,34(12):12 - 18.
[12] 杨荣,王明伟,刘思铭. 基于图像处理算法的目标识别、
定位与跟踪系统设计与实现[ J]. 物联网技术,2020,10
(09):75 - 79.
Yang R,Wang M W,Liu S M. Design and implementation of
target recognition,location and tracking system based on im⁃
age processing algorithm[J]. Internet of things technology,
2020,10 (09):75 - 79.
[13] 任静. 结合 Kalman 滤波器的 SIFT 目标跟踪算法[ J]. 计
算技术与自动化,2017,36(04):80 - 83.
Ren J. SIFT target tracking algorithm combined with Kalman
filter[ J]. Computing technology and automation,2017,36
(04):80 - 83.
[14] 刘旭航,刘小雄,章卫国,等. 基于加速度修正模型的无
人机姿态解算算法[ J]. 西 北 工 业 大 学 学 报,2021,39
(01):175 - 181.
Liu X H,Liu X X,Zhang W G,et al. UAV attitude calcula⁃
tion algorithm based on acceleration correction model[ J].
Journal of Northwest University of Technology, 2021, 39
(01):175 - 181.
科学编辑 杨继森 博士(重庆理工大学教授)
责任编辑 唐定国
■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■
( 上接第 277 页)
[16] 陈红松,陈京九. 基于循环神经网络的无线网络入侵检
测分类 模 型 构 建 与 优 化 研 究 [ J]. 电 子 与 信 息 学 报,
2019,41(06):1427 - 1433.
Chen H S,Chen J J. Recurrent neural networks based wire⁃
less network intrusion detection and classification model
construction and optimization[ J]. Journal of Electronics &
Information Technology,2019,41(06):1427 - 1433.
[17] Wang D,Zhang X. THCHS⁃30:A free chinese speech cor⁃
pus[ EB / OL]. [ 2015 - 10 - 07 ]. http: / / arxiv. org / abs /
1512. 01882.
[18] Allen J B,Berkley D A. Image method for efficiently simu⁃
lating small⁃room acoustics[ J]. The Journal of the Acous⁃
tical Society of America,1998,65(04):943 - 950.
[19] 胡广书. 数字信号处理导论[M]. 2 版. 北京:清华大学出
版社,2013:23.
Hu G S. Introduction to digital signal processing[ M]. 2nd
Edition. Beijing:Tsinghua University Press,2013:23.
[20] Hong Q Y,Li L,Li M,et al. Modified⁃prior PLDA and score
calibration for duration mismatch compensation in speaker
recognition system[C] / / Proc. of the Interspeech,2015.
[21] Liu L,Cai L,Ma L,et al. Channel state information predic⁃
tion for adaptive underwater acoustic downlink OFDMA sys⁃
tem:Deep neural networks based approach[J]. IEEE Trans⁃
actions on Vehicular Technology, 2021, 70 ( 09 ): 9063
- 9076.
科学编辑 曾浩 博士(重庆大学教授、博导)
责任编辑 唐定国
296 兵 器 装 备 工 程 学 报 http: / / bzxb. cqut. edu. cn / ■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■